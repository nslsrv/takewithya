#!/bin/bash
set -euo pipefail

# This script prepares upstream sources for YANDEX.generate.sh.

# Delete tests.
tests=$(find pandas -type d -name tests)
rm -rf $tests

# Delete generated files.
find pandas -type f -exec fgrep -q 'Generated by Cython' {} \; -print -delete

# Add missing static declarations.
# Regular "patch" skips the first file in the patch.
git apply YANDEX.patch

# Absolutize imports.
sed -e 's/initjson/init6pandas4json/' \
    -e '/Py_InitModule/ s/json/pandas.json/' \
    -i pandas/src/ujson/python/ujson.c

# Move files into place, according to setup.extensions.
mv -n pandas/src/join.pyx    pandas/_join.pyx
mv -n pandas/src/period.pyx  pandas/_period.pyx
mv -n pandas/src/sparse.pyx  pandas/_sparse.pyx
mv -n pandas/src/testing.pyx pandas/_testing.pyx
mv -n pandas/window.pyx      pandas/_window.pyx

# Move pandas/src/* into pandas/ to avoid unsupported cython -I argument.
mv -n pandas/src/msgpack pandas/src.msgpack
mv -n pandas/src/* pandas/
mv -n pandas/src.msgpack pandas/src/msgpack

sed -e 's|src/headers/|headers/|g' \
    -i pandas/algos.pyx pandas/_window.pyx
